# tech.skadi.test

## Пакет `com.upuphone.starrynet.core`
Ниже собрана справка по основным классам ядра, через которые приложение работает с устройствами (включая очки) по Bluetooth/Wi‑Fi и сопутствующим транспортам. Описание сгруппировано по подмодулям.

### Wi‑Fi AP (`core.ap`)
* `WiFiApBaseManager` – базовый `BroadcastReceiver`, создаёт конфигурации точки доступа и хранит ссылку на `WifiManager`. Предоставляет метод `getConfig(ssid, pwd)` для сборки `WifiConfiguration` и переопределяемый `onReceive`. 【F:sources/com/upuphone/starrynet/core/ap/WiFiApBaseManager.java†L10-L28】
* `WiFiApManager` – управляет созданием soft AP: генерирует порт/SSID/пароль, вызывает рефлексивные методы `startSoftAp`/`stopSoftAp`, отслеживает состояние `WIFI_AP_STATE_CHANGED` и уведомляет `IWiFiApCallback` об успехе/закрытии. 【F:sources/com/upuphone/starrynet/core/ap/WiFiApManager.java†L13-L120】【F:sources/com/upuphone/starrynet/core/ap/WiFiApManager.java†L122-L194】
* `WiFiApStaManager` – клиент для подключения к точке: собирает `WifiConfiguration`, включает сеть, отслеживает `CONNECTIVITY_CHANGE`, вычисляет адрес сервера и уведомляет `IWiFiStaCallback` о подключении/разрыве/ошибках. 【F:sources/com/upuphone/starrynet/core/ap/WiFiApStaManager.java†L16-L125】【F:sources/com/upuphone/starrynet/core/ap/WiFiApStaManager.java†L127-L211】
* DTO/интерфейсы: `WiFiApInfo` хранит SSID/пароль/порт/peerId; `IWiFiApCallback` и `IWiFiStaCallback` описывают события точки доступа и клиента. 【F:sources/com/upuphone/starrynet/core/ap/WiFiApInfo.java†L4-L48】【F:sources/com/upuphone/starrynet/core/ap/IWiFiApCallback.java†L1-L7】【F:sources/com/upuphone/starrynet/core/ap/IWiFiStaCallback.java†L1-L11】

### DNS-SD (`core.dns`)
* `NsdServiceManager` – обёртка над `NsdManager`, умеет регистрировать сервис, запускать/останавливать discovery и resolve, преобразуя callback’и в сообщения `Handler` и пробрасывая их через `INsdServiceCallback`. 【F:sources/com/upuphone/starrynet/core/dns/NsdServiceManager.java†L1-L118】【F:sources/com/upuphone/starrynet/core/dns/NsdServiceManager.java†L150-L231】
* `INsdServiceCallback` – интерфейс для событий обнаружения/резолва/регистрации. 【F:sources/com/upuphone/starrynet/core/dns/INsdServiceCallback.java†L1-L16】
* Логирование и коды ошибок: `NsdLog` наследует `StLog`, `ErrorCode` хранит константы исключений регистрации/дискавери. 【F:sources/com/upuphone/starrynet/core/dns/NsdLog.java†L1-L10】【F:sources/com/upuphone/starrynet/core/dns/ErrorCode.java†L1-L8】

### Локальная база (`core.database`)
* `StarryDatabase` – синглтон вокруг `MMKV`, сохраняет/чтёт объекты `BondInfo` по ключу hex‑идентификатора устройства, поддерживает выборку всех записей и удаление. Используется для кеша связок устройств. 【F:sources/com/upuphone/starrynet/core/database/StarryDatabase.java†L1-L74】
* `BondInfo` – Parcelable/Cloneable модель сведений о связке: идентификатор, тип устройства/терминала, протокол, компания/модель, имя, MAC Br/EDR, шифр, таймстемп и статус. Реализует `equals/hashCode`, `toString`, сериализацию в Parcel. 【F:sources/com/upuphone/starrynet/core/database/dao/BondInfo.java†L1-L121】【F:sources/com/upuphone/starrynet/core/database/dao/BondInfo.java†L123-L196】

### Wi‑Fi Direct P2P (`core.p2p`)
* `WiFiP2pBaseManager` – базовый менеджер P2P: регистрирует широковещательный приёмник для событий Wi‑Fi/P2P, хранит `WifiP2pManager/Channel`, отслеживает MAC P2P, умеет закрывать/открывать dual‑Wi‑Fi, переводить частоты в номер канала и реагировать на смену состояния. 【F:sources/com/upuphone/starrynet/core/p2p/WiFiP2pBaseManager.java†L1-L125】【F:sources/com/upuphone/starrynet/core/p2p/WiFiP2pBaseManager.java†L125-L196】
* Методы подготовлены для наследников: `onP2pConnectChange`, `onP2pEnable/Disable`, `onWifiDisable`, `requestP2pDevice` и др. Используется в конкретных реализациях GO/GC. 【F:sources/com/upuphone/starrynet/core/p2p/WiFiP2pBaseManager.java†L198-L252】
* `IP2pConnectCallback` (в каталоге) задаёт контракт уведомлений о подключении; подкаталог `bean` содержит структуры данных (`GoInfo` и т.п.), а `halbinder` – AIDL‑обвязку STA HAL для работы с частотами/каналом (XjSupplicantStaIfaceHal…).

### BLE обработка данных (`core.ble.manager` и канал)
* `BleDataDispatcher` – очередной диспетчер входящих BLE пакетов: принимает `BleReceiveData`, маршрутизирует по зарегистрированным `IBleDataReceiver`, поддерживает «sticky» пакеты, таймаут ожидания и сигнализацию о завершении передачи крупного сообщения. 【F:sources/com/upuphone/starrynet/core/ble/manager/BleDataDispatcher.java†L1-L93】【F:sources/com/upuphone/starrynet/core/ble/manager/BleDataDispatcher.java†L95-L160】
* `BleReceiveData` (данные пакета) и `BleReceiveMsgManager`, `IBleDataReceiver/IBleMultiDataReceiver` обеспечивают очередь, сборку многочастных сообщений и API приёма.
* Подпакет `ble.channel` реализует собственный протокол поверх BLE GATT: классы `Channel/ChannelSocket/SendChannel/ReceiveChannel` управляют состоянием канала и передачей, `ChannelManager` и `IChannelStateHandler` отслеживают state‑машину, `ChannelStateBlock` кодирует флаги. Пакеты описаны в `packet.*` (CTR/ACK/Data/FastAck и т.д.), `CRC32` рассчитывает контрольные суммы. Эти компоненты отвечают за надёжную доставку и буферизацию сообщений между телефоном и очками.
* `SystemActionObserver`, `BluetoothContextManager`, `Constants/BluetoothConstants`, `BleProtocolVersion` предоставляют вспомогательные константы и контекст для работы BLE‑стека.

### Classic Bluetooth Br/EDR (`core.bredr`)
* Базовая логика управления профилями Br/EDR: `BrEdrManager` и производные Master/Slave обеспечивают поиск/подключение, `BrEdrEventManager` транслирует события, `BrEdrDeviceManager` хранит состояние устройств. Профили (`profile`) включают `BrEdrA2dpManager`/`SinkManager`, `BrEdrHfpManager`/`HfpClientManager`, `BrEdrPbapManager` и общий `BrEdrBaseProfile` с интерфейсами обратных вызовов (`listener` пакет). Эти классы отвечают за работу со звуком/гарнитурой очков через классический Bluetooth.

### SPP (`core.spp`)
* Реализация последовательного профиля: `SPPConnectionManager` создаёт `SPPConnection` (клиент/сервер), планирует `SPPReadTask`/`SPPWriteTask`, а `SPPServerListener`/`IConnectionEventListener`/`ICommonServerListener` сообщают о событиях. Классы `a`–`e` инкапсулируют внутренние слушатели/обработчики. Слой SPP используется для обмена данными поверх Br/EDR, когда устройству нужен потоковый канал.

### USB (`core.usb`)
* `UsbStarryManager` и `UsbAccessoryManager/BaseManager` управляют обнаружением USB‑аксессуаров очков, `UsbAccessoryReceiver` ловит системные broadcast’ы, `IUsbStarryDiscoverListener` сообщает о найденных устройствах. Эти классы дают альтернативный проводной канал помимо Bluetooth.

### Автомобильные сценарии (`core.car`)
* `CarBaseManager/CarManager/CarManager371` реализуют управление подключением очков в автомобильном режиме, используя интерфейс `ICarManagerCallback`. Вспомогательный `Utils` содержит методы конвертации/проверки состояния. Пакет поддерживает разные реализации для платформ.

## Общая логика работы с очками через Bluetooth
1. **Установление связи и поиск**: очки могут выступать в роли BLE‑периферии или Br/EDR устройства. Для надёжной связи используется собственный BLE‑канал (`ble.channel`) с контролем состояния и пакетированием. При необходимости используется SPP или профили A2DP/HFP/PBAP из пакета `bredr` для аудио/телефонии.
2. **Обмен данными**: входящие BLE пакеты принимаются через `BleDataDispatcher`, который собирает многочастные сообщения и передаёт их в нужные обработчики. Для классического Bluetooth обмен идёт через `SPPConnectionManager` или профильные менеджеры, а данные о связке сохраняются в `StarryDatabase` (`BondInfo`). 【F:sources/com/upuphone/starrynet/core/ble/manager/BleDataDispatcher.java†L43-L118】【F:sources/com/upuphone/starrynet/core/database/StarryDatabase.java†L28-L74】
3. **Сопутствующие каналы**: при необходимости создаётся точка доступа (`WiFiApManager`) или клиент (`WiFiApStaManager`) для высокоскоростной передачи; Wi‑Fi Direct (`WiFiP2pBaseManager` и наследники) обеспечивает прямое P2P‑соединение. DNS‑SD (`NsdServiceManager`) помогает обнаруживать сервисы по сети. 【F:sources/com/upuphone/starrynet/core/ap/WiFiApManager.java†L56-L115】【F:sources/com/upuphone/starrynet/core/ap/WiFiApStaManager.java†L68-L142】【F:sources/com/upuphone/starrynet/core/p2p/WiFiP2pBaseManager.java†L1-L125】【F:sources/com/upuphone/starrynet/core/dns/NsdServiceManager.java†L1-L118】
4. **Хранение привязок**: идентификаторы и параметры очков/телефона сохраняются в `StarryDatabase`, чтобы при повторном подключении использовать кэш и восстанавливать шифровальные ключи/статус. 【F:sources/com/upuphone/starrynet/core/database/StarryDatabase.java†L28-L74】【F:sources/com/upuphone/starrynet/core/database/dao/BondInfo.java†L1-L121】


## Подробная Bluetooth‑цепочка: классы и события
### Базовые утилиты и константы
* `BluetoothContextManager` — хранит `Context`, управляет выделенным потоком `CORE-BLE` и обработчиком, через который выполняются все BLE задачи; инициализирует `SystemActionObserver` и флаг типа сборки. 【F:sources/com/upuphone/starrynet/core/ble/BluetoothContextManager.java†L8-L52】
* `SystemActionObserver` — регистрирует `BroadcastReceiver` для экран/BT‑событий, включает Bluetooth при необходимости и рассылает callbacks через главный поток. Держит актуальные флаги `isBluetoothOn`/`isScreenOn`. 【F:sources/com/upuphone/starrynet/core/ble/SystemActionObserver.java†L17-L163】
* `BluetoothConstants` — набор UUID сервиса/характеристик StarryNet, коды статуса и вспомогательные ключи для пакетов и MTU. 【F:sources/com/upuphone/starrynet/core/ble/BluetoothConstants.java†L9-L44】

### Клиентская цепочка BLE (телефон → очки)
1. **Вход в BLE поток**: публичные вызовы проксируются через `BleConnectManager`, который создаёт/кеширует `BleConnectMaster` по MAC адресу и пересылает методы connect/read/write/notify в BLE‑поток через `ProxyBulk`. Синглтон следит за лимитом активных мастеров и автоочисткой неиспользуемых соединений. 【F:sources/com/upuphone/starrynet/core/ble/client/BleConnectManager.java†L25-L170】
2. **Жизненный цикл мастера**: `BleConnectMaster` запускает отдельный `MessageHandlerThread` на каждое устройство, лениво инициализирует `BleRequestDispatcher` и ставит таймеры «живости» (15 секунд проверка, 120 секунд предел). При каждом вызове через прокси обновляется таймстемп; при тайм‑ауте поток останавливается. 【F:sources/com/upuphone/starrynet/core/ble/client/BleConnectMaster.java†L28-L142】
3. **Пошаговое подключение**: `connect(BleConnectConfig, BleConnectResponse)` внутри мастера передаёт запрос в `BleRequestDispatcher`, который в свою очередь открывает GATT, настраивает MTU/notify и проверяет наличие нужных характеристик (используются UUID из `BluetoothConstants`). `cancelConnecting()`/`disconnect()` вызываются напрямую, чтобы обрывать GATT или завершить поток. 【F:sources/com/upuphone/starrynet/core/ble/client/BleConnectMaster.java†L115-L142】【F:sources/com/upuphone/starrynet/core/ble/client/BleConnectManager.java†L81-L170】【F:sources/com/upuphone/starrynet/core/ble/BluetoothConstants.java†L9-L44】
4. **Работа с данными**: `BleConnectManager` пробрасывает `read`/`write`/`writeNoRsp`/`notify` и запрос MTU в мастер, который делегирует их диспетчеру. Ответы упаковываются через `BleResponser`, выполняются в BLE‑потоке и поступают в UI‑callback. 【F:sources/com/upuphone/starrynet/core/ble/client/BleConnectManager.java†L112-L165】【F:sources/com/upuphone/starrynet/core/ble/client/BleConnectMaster.java†L144-L159】
5. **Контроль состояний**: `checkAlive()` в мастере смотрит, не отвалилось ли устройство (`BluetoothUtils.isBleDeviceDisconnected`) и не превысил ли период бездействия; иначе останавливает поток. Менеджер периодически чистит мастеров, которые не были помечены как клиентские и не отвечали >60 секунд. 【F:sources/com/upuphone/starrynet/core/ble/client/BleConnectMaster.java†L49-L109】【F:sources/com/upuphone/starrynet/core/ble/client/BleConnectManager.java†L37-L63】

### Классический Bluetooth: Br/EDR и SPP
* **Профили Br/EDR**: менеджеры `BrEdrManager`/`BrEdrMasterManager`/`BrEdrSlaveManager` (и профильные A2DP/HFP/PBAP классы) отвечают за поиск, сопряжение и управление аудио‑/гарнитурными возможностями очков. Они уведомляют слушателей о состоянии и выбирают нужный профиль под сценарий звонков/звукопередачи.
* **Последовательный порт (SPP)**: `SPPConnectionManager` поднимает клиент/сервер SPP, назначает задачи чтения/записи и через обратные вызовы сообщает о подключении/разрыве. Этот слой используется, когда очкам нужен стабильный поток данных через классический BT.

### Как очки подключаются к телефону (поминутная картина)
1. **Проверка окружения**: при старте приложения вызывается `BluetoothContextManager.setContext(...)`, который разворачивает поток `CORE-BLE` и регистрирует системные наблюдатели. `SystemActionObserver` сразу сохраняет состояние Bluetooth/экрана и подписывается на будущие изменения, по необходимости включая адаптер. 【F:sources/com/upuphone/starrynet/core/ble/BluetoothContextManager.java†L14-L48】【F:sources/com/upuphone/starrynet/core/ble/SystemActionObserver.java†L81-L137】
2. **Выбор устройства**: получив MAC очков, приложение вызывает `BleConnectManager.connect(...)`. Менеджер гарантирует существование `BleConnectMaster`, помечает устройство как «клиентский запрос» и передаёт конфиг в мастера. 【F:sources/com/upuphone/starrynet/core/ble/client/BleConnectManager.java†L51-L99】
3. **Открытие GATT**: мастер стартует свой поток, лениво собирает `BleRequestDispatcher` и инициирует GATT‑соединение. После подключения диспетчер проверяет сервис `STARRY_NET_SERVICE_UUID` и характеристики чтения/записи, подписывает уведомления на `XR_NOTIFY_UUIDS`, запрашивает MTU, сохраняя коды/байты через ключи `KEY_CODE/KEY_BYTES`. 【F:sources/com/upuphone/starrynet/core/ble/client/BleConnectMaster.java†L93-L142】【F:sources/com/upuphone/starrynet/core/ble/BluetoothConstants.java†L9-L44】
4. **Обмен сообщениями**: все операции чтения/записи, а также поточные блоки `writeBatchNoRsp` идут через менеджер → мастер → диспетчер и завершаются в BLE‑потоке. Ответы уведомлений приходят в `BleDataDispatcher` и далее в канал передачи (`ble.channel`), где пакеты собираются, проверяются CRC и подтверждаются ACK. 【F:sources/com/upuphone/starrynet/core/ble/client/BleConnectManager.java†L112-L165】【F:sources/com/upuphone/starrynet/core/ble/client/BleConnectMaster.java†L144-L159】【F:sources/com/upuphone/starrynet/core/ble/manager/BleDataDispatcher.java†L43-L160】
5. **Поддержание сессии**: мастер каждые 15 секунд планирует проверку `CHECK_ALIVE`; если за 120 секунд не было вызовов и устройство считается offline, поток закрывается. На уровне менеджера аналогичная очистка срабатывает, когда устройство не отмечено как активный клиент и не откликается. 【F:sources/com/upuphone/starrynet/core/ble/client/BleConnectMaster.java†L49-L109】【F:sources/com/upuphone/starrynet/core/ble/client/BleConnectManager.java†L37-L63】
6. **Отключение и повторное подключение**: `disconnect()` или `cancelConnecting()` вызываются через менеджер и немедленно доходят до диспетчера; при удалении мастера из карты его поток останавливается. Повторное подключение создаёт новый мастер, но кэш клиента позволяет переиспользовать состояние и ключи сервиса. 【F:sources/com/upuphone/starrynet/core/ble/client/BleConnectManager.java†L81-L170】【F:sources/com/upuphone/starrynet/core/ble/client/BleConnectMaster.java†L111-L122】
